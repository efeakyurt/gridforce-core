<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRIDFORCE COMMAND</title>
    <style>
        :root {
            --bg-color: #050505;
            --text-color: #00ff41;
            --border-color: #00ff41;
            --font-main: 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        header {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            font-size: 2em;
            text-shadow: 0 0 5px var(--text-color);
        }

        .container {
            display: flex;
            gap: 20px;
            flex: 1;
        }

        .panel {
            border: 1px solid var(--border-color);
            padding: 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(0, 255, 65, 0.05);
        }

        .panel-header {
            font-size: 1.2em;
            font-weight: bold;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th,
        td {
            text-align: left;
            padding: 5px;
        }

        th {
            border-bottom: 1px solid var(--border-color);
        }

        .status-online {
            color: #00ff41;
            font-weight: bold;
        }

        .btn-dispatch {
            background: var(--bg-color);
            color: var(--text-color);
            border: 2px solid var(--border-color);
            padding: 15px 30px;
            font-family: var(--font-main);
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .btn-dispatch:hover {
            background: var(--text-color);
            color: var(--bg-color);
            box-shadow: 0 0 15px var(--text-color);
        }

        .terminal {
            background-color: #000;
            border: 1px solid #333;
            padding: 10px;
            font-size: 0.85em;
            height: 150px;
            overflow-y: auto;
            margin-top: 20px;
            color: #ccc;
        }

        .log-entry::before {
            content: "> ";
            color: #555;
        }
    </style>
</head>

<body>

    <header>
        <h1>GRIDFORCE COMMAND</h1>
        <div id="clock">00:00:00</div>
    </header>

    <div class="container">
        <div class="panel">
            <div class="panel-header">ACTIVE NODES</div>
            <table id="nodes-table">
                <thead>
                    <tr>
                        <th>Device ID</th>
                        <th>WALLET ID</th>
                        <th>SPECS</th>
                        <th>GRID SCORE</th>
                        <th>IP Address</th>
                        <th>Status</th>
                        <th>EARNINGS ($GRID)</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Nodes will be inserted here -->
                </tbody>
            </table>
        </div>

        <div class="panel">
            <div class="panel-header">JOB HISTORY</div>
            <table id="jobs-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Node</th>
                        <th>Image</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Jobs will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="panel" style="margin-top: 20px; background: rgba(0, 255, 65, 0.1);">
        <div class="panel-header">SUBMIT COMPUTE TASK</div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" id="api-key" value="sk_live_demo12345" placeholder="API Key"
                style="padding: 10px; background: #000; color: #ffd700; border: 1px solid #ffd700; flex: 1;">
            <input type="text" id="job-image" value="python:3.9-alpine" placeholder="Docker Image"
                style="padding: 10px; background: #000; color: #00ff41; border: 1px solid #00ff41; flex: 1;">
            <input type="text" id="job-cmd" value='python -c "print(f\"Computed: {123 * 456}\")"' placeholder="Command"
                style="padding: 10px; background: #000; color: #00ff41; border: 1px solid #00ff41; flex: 3;">
            <button class="btn-dispatch" onclick="dispatchJob()"
                style="margin-top: 0; padding: 10px 20px;">SUBMIT</button>
        </div>
    </div>

    <div class="panel" style="margin-top: 20px; border: 1px solid #ff00ff; padding: 20px;">
        <div class="panel-header" style="color: #ff00ff; border-color: #ff00ff;">BUSINESS CONTROL</div>
        <button class="btn-dispatch" onclick="generateCustomerKey()"
            style="border-color: #ff00ff; color: #ff00ff; margin-top: 0;">Generate New Customer Key ($1000
            Credits)</button>
        <button class="btn-dispatch" onclick="runGlobalBenchmark()"
            style="border-color: cyan; color: cyan; margin-top: 10px;">RUN GLOBAL BENCHMARK</button>
        <div id="newKeyDisplay"
            style="margin-top: 15px; font-weight: bold; font-family: monospace; color: #ff00ff; font-size: 1.2em;">
        </div>
    </div>

    <div class="panel" style="margin-top: 20px; border: 1px solid var(--border-color); padding: 20px;">
        <div class="panel-header">BECOME A PROVIDER</div>
        <p style="margin: 10px 0;">1. Download the Client Miner.</p>
        <a href="/downloads/client" download class="btn-dispatch"
            style="display: inline-block; text-decoration: none; text-align: center; margin-bottom: 10px;">DOWNLOAD
            MINER (v1.0)</a>
        <p style="margin: 10px 0;">2. Run via terminal: <code>./client -wallet YOUR_WALLET</code></p>
    </div>

    <div class="terminal" id="terminal">
        <div class="log-entry">System Ready...</div>
    </div>

    <script>
        function log(msg) {
            const term = document.getElementById('terminal');
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerText = msg;
            term.appendChild(div);
            term.scrollTop = term.scrollHeight;
        }

        function updateClock() {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        }
        setInterval(updateClock, 1000);

        async function fetchNodes() {
            try {
                const response = await fetch('/api/nodes');
                const nodes = await response.json();
                const tbody = document.querySelector('#nodes-table tbody');
                tbody.innerHTML = '';
                nodes.forEach(node => {
                    const tr = document.createElement('tr');
                    let walletDisplay = "N/A";
                    if (node.wallet && node.wallet.length > 10) {
                        walletDisplay = node.wallet.substring(0, 6) + "..." + node.wallet.substring(node.wallet.length - 4);
                    } else if (node.wallet) {
                        walletDisplay = node.wallet;
                    }

                    tr.innerHTML = `
                    <td>${node.device}</td>
                    <td style="font-family: monospace; color: #aaa;">${walletDisplay}</td>
                    <td style="font-size: 0.8em; color: #88ff88;">${node.specs || "N/A"}</td>
                    <td style="color: cyan; font-weight: bold;">${node.benchmark_score || "-"}</td>
                    <td>${node.ip}</td>
                    <td class="status-online">${node.status}</td>
                    <td style="color: #00ff41; text-shadow: 0 0 5px #00ff41;">${node.tokens || 0} GRID</td>
                `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                // silent fail
            }
        }

        async function fetchJobs() {
            try {
                const response = await fetch('/api/jobs');
                const jobs = await response.json();
                const tbody = document.querySelector('#jobs-table tbody');
                tbody.innerHTML = '';
                jobs.forEach(job => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td>${job.ID}</td>
                    <td>${job.NodeID}</td>
                    <td>${job.Image}</td>
                    <td>${job.Result.substring(0, 30)}${job.Result.length > 30 ? '...' : ''}</td>
                `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                // silent fail
            }
        }

        async function dispatchJob() {
            const image = document.getElementById('job-image').value;
            // Parse command string into array (simple split by space, handling quotes is complex but keeping simple for demo)
            // For better UX, we assume the command is a single string we pass to shell or just use sh -c which is complex
            // THE USER REQUESTED: Input: "Command" (default: python -c "...")
            // We will take the full string and split it properly or just send it as array if user knows format.
            // Let's assume user inputs a full command string, and we need to tokenize it roughly for Docker Cmd []string.
            // Or simpler: Just take the whole string as one argument to /bin/sh -c? 
            // No, the previous implementation expected ["echo", "msg"].
            // Let's do a naive split but respecting quotes is hard in vanilla JS without regex.
            // For the demo: We will specific logic for the default python command or just simple space split.
            // Actually, user asked for: Input: "Command"
            // Let's try to be smart. If it starts with "python -c", we handle it.
            // Creating a proper tokenizer in 10 lines:

            let cmdStr = document.getElementById('job-cmd').value;
            let cmdArr = [];
            let current = '';
            let inQuote = false;
            for (let i = 0; i < cmdStr.length; i++) {
                let char = cmdStr[i];
                if (char === '"' || char === "'") {
                    inQuote = !inQuote;
                    // current += char; // Keep quotes? Docker cmd usually needs args without shell quotes.
                } else if (char === ' ' && !inQuote) {
                    if (current.length > 0) cmdArr.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            if (current.length > 0) cmdArr.push(current);

            // Fallback if empty
            if (cmdArr.length === 0) cmdArr = ["echo", "Empty Command"];

            log(`Initiating Job Dispatch: ${image} -> ${cmdArr.join(' ')}`);

            const apiKey = document.getElementById('api-key').value;

            try {
                const res = await fetch('/jobs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey
                    },
                    body: JSON.stringify({
                        image: image,
                        cmd: cmdArr
                    })
                });
                if (res.ok) {
                    log("Job Dispatched Successfully.");
                } else {
                    const txt = await res.text();
                    log("Error: " + txt);
                }
            } catch (e) {
                log("Critical Error: " + e);
            }
        }

        async function generateCustomerKey() {
            try {
                const res = await fetch('/api/admin/create-customer', { method: 'POST' });
                const data = await res.json();
                const display = document.getElementById('newKeyDisplay');
                display.innerText = `NEW KEY: ${data.api_key} | CREDITS: ${data.credits}`;
                log(`Generated New Customer: ${data.api_key}`);

                // Auto-fill input for convenience
                document.getElementById('api-key').value = data.api_key;
            } catch (e) {
                log("Error Generating Key: " + e);
            }
        }

        async function runGlobalBenchmark() {
            const apiKey = document.getElementById('api-key').value;
            const image = "python:3.9-alpine";
            // Command to calculate 20M squares and print score based on execution time
            const cmdArr = ["python", "-c", "import time; s=time.time(); [x**2 for x in range(20000000)]; print('BENCHMARK_SCORE:' + str(int(10000/(time.time()-s))))"];

            log("Initiating Global Benchmark Sequence...");

            try {
                const res = await fetch('/jobs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': apiKey
                    },
                    body: JSON.stringify({
                        image: image,
                        cmd: cmdArr
                    })
                });
                if (res.ok) {
                    log("Benchmark Job Dispatched Successfully.");
                } else {
                    const txt = await res.text();
                    log("Error: " + txt);
                }
            } catch (e) {
                log("Critical Error: " + e);
            }
        }

        // Polling
        setInterval(fetchNodes, 2000);
        setInterval(fetchJobs, 5000);

        // Initial fetch
        fetchNodes();
        fetchJobs();
    </script>

</body>

</html>